# Traefik Reverse Proxy Docker Setup

A complete Docker-based Traefik reverse proxy setup with HTTP (port 80) and HTTPS (port 443) support, including Let's Encrypt certificate automation via Route53 DNS challenge.

## Features

- **Traefik v2.11** - Modern reverse proxy and load balancer
- **HTTP & HTTPS Support** - Configured for ports 80 (HTTP) and 443 (HTTPS)
- **Let's Encrypt Integration** - Automatic SSL/TLS certificates via Route53 DNS challenge
- **Dashboard** - Web UI accessible on port 8888
- **Docker Provider** - Automatic service discovery from Docker containers
- **File Provider** - Dynamic configuration via `dynamic.yml` (no restart required)
- **Management Scripts** - Easy-to-use scripts for common operations
- **Backup & Restore** - Built-in backup and restore functionality
- **Health Checks** - Container health monitoring
- **Smart Setup** - Preserves existing configuration files during setup

## Quick Start

### Prerequisites

- Docker and Docker Compose installed
- Linux system (tested on Ubuntu/Debian/Raspberry Pi OS)
- Network access for downloading Docker images
- Ports 80 and 443 available (or change in docker-compose.yml)
- **AWS Account** with Route53 DNS hosting (for Let's Encrypt DNS challenge)
- **AWS Credentials** - Access Key ID and Secret Access Key with Route53 permissions

### Installation

1. **Clone or download this repository:**
   ```bash
   git clone <repository-url>
   cd traefik
   ```

2. **Set up AWS credentials** (required for Let's Encrypt DNS challenge):
   ```bash
   export AWS_ACCESS_KEY_ID="your-access-key-id"
   export AWS_SECRET_ACCESS_KEY="your-secret-access-key"
   export AWS_REGION="your-aws-region"  # e.g., us-east-1
   ```

3. **Run the setup script:**
   ```bash
   chmod +x setup.sh
   ./setup.sh
   ```
   
   **Note:** The setup script will preserve existing `config/traefik.yml` and `config/dynamic.yml` files if they already exist, and will create backups before overwriting `docker-compose.yml`.

4. **Create ACME.json file** (for Let's Encrypt certificates):
   ```bash
   touch acme.json
   chmod 600 acme.json
   ```

5. **Start Traefik:**
   ```bash
   ./scripts/manage.sh start
   ```

4. **Access Traefik Dashboard:**
   - Open your web browser
   - Navigate to `http://YOUR-IP:8888`
   - Or: `http://traefik.localhost:8888`

## Management

Use the management script for common operations:

```bash
# Start Traefik
./scripts/manage.sh start

# Stop Traefik
./scripts/manage.sh stop

# Restart Traefik
./scripts/manage.sh restart

# View logs
./scripts/manage.sh logs

# Check status
./scripts/manage.sh status

# Update to latest version
./scripts/manage.sh update

# Create backup
./scripts/manage.sh backup

# Restore from backup
./scripts/manage.sh restore /path/to/backup.tar.gz

# Show dashboard URL
./scripts/manage.sh dashboard

# Access container shell
./scripts/manage.sh shell
```

## Directory Structure

```
./
├── docker-compose.yml          # Docker Compose configuration (generated by setup.sh)
├── setup.sh                   # Initial setup script
├── acme.json                  # Let's Encrypt certificate storage (create with chmod 600)
├── config/
│   ├── traefik.yml           # Main Traefik configuration
│   └── dynamic.yml           # Dynamic configuration (can be modified without restart)
├── scripts/
│   └── manage.sh             # Management script
├── data/                      # Traefik data directory
└── backups/                   # Configuration backups
```

## Configuration

### Main Configuration (`config/traefik.yml`)

The main Traefik configuration file includes:
- API/Dashboard settings
- Entry points: HTTP (port 80) and HTTPS (port 443)
- **Let's Encrypt Certificate Resolver** - Route53 DNS challenge configuration
- Docker provider for automatic service discovery
- File provider for dynamic configuration

**Key Configuration:**
- Certificate resolver: `r53` (Route53 DNS challenge)
- Email: `Mich@elDevlin.com` (for Let's Encrypt notifications)
- DNS challenge delay: 60 seconds (for DNS propagation)

### Dynamic Configuration (`config/dynamic.yml`)

This file can be modified without restarting Traefik. Currently configured with:
- **Service Routers** - HTTPS routing for multiple services:
  - `homeassistant.broken.network`
  - `musicassistant.broken.network`
  - `portainer.broken.network`
  - `www.broken.network`
- **TLS Configuration** - Automatic certificate management via Route53 resolver
- **Wildcard Certificates** - Supports `*.broken.network` wildcard certificates
- **Service Definitions** - Backend service URLs and ports

**Note:** Modify this file to add or remove services. Changes are automatically detected and applied without restarting Traefik.

### Adding Services to Traefik

There are two ways to add services to Traefik:

#### Method 1: Docker Labels (Automatic Discovery)

Add labels to your service containers for automatic discovery:

```yaml
services:
  myservice:
    image: myimage:latest
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.myservice.rule=Host(`myservice.broken.network`)"
      - "traefik.http.routers.myservice.entrypoints=websecure"
      - "traefik.http.routers.myservice.tls.certresolver=r53"
      - "traefik.http.services.myservice.loadbalancer.server.port=8080"
    networks:
      - traefik
```

#### Method 2: Dynamic Configuration File (Manual)

Add service definitions to `config/dynamic.yml`:

```yaml
http:
  routers:
    myservice:
      rule: "Host(`myservice.broken.network`)"
      entryPoints:
        - websecure
      service: myservice
      tls:
        certResolver: r53
  
  services:
    myservice:
      loadBalancer:
        servers:
          - url: "http://myservice.broken.network:8080"
```

**Important:** 
- Services must be on the `traefik` network to be discovered
- For HTTPS services, use `websecure` entry point and `r53` certificate resolver
- DNS records must point to your server's IP address

## Ports

- **80** - HTTP entry point (main traffic)
- **443** - HTTPS entry point (secure traffic)
- **8888** - Traefik dashboard (web UI)

## Security

### Important Security Notes

1. **HTTPS/SSL Configuration:**
   - HTTPS is fully configured and enabled on port 443
   - Let's Encrypt certificates are automatically obtained and renewed
   - Route53 DNS challenge is used (no need to expose port 80 publicly)
   - Certificates are stored in `acme.json` (keep this file secure!)

2. **AWS Credentials:**
   - AWS credentials are required for Route53 DNS challenge
   - Credentials are passed via environment variables
   - Ensure AWS IAM user has minimal required permissions (Route53 DNS management)
   - **Never commit `acme.json` or AWS credentials to version control**

3. **ACME.json File:**
   - Contains Let's Encrypt certificates and private keys
   - Must have restricted permissions: `chmod 600 acme.json`
   - Included in `.gitignore` - never commit this file
   - Back up regularly as part of your backup strategy

4. **Dashboard Security:**
   - Dashboard is accessible via HTTP on port 8888
   - Consider restricting dashboard access to localhost or VPN
   - For production, configure HTTPS and authentication for dashboard

5. **Network Security:**
   - Consider restricting access to trusted networks
   - Use firewall rules to limit access
   - Consider VPN for remote access

6. **Docker Socket Access:**
   - Traefik has read-only access to Docker socket
   - This allows automatic service discovery
   - Only install on trusted machines

7. **Updates:**
   - Regularly update Traefik: `./scripts/manage.sh update`
   - Monitor security advisories
   - Keep Docker host system updated
   - Monitor certificate expiration (automatic renewal via Let's Encrypt)

### Let's Encrypt / Route53 DNS Challenge

The setup uses Route53 DNS challenge for Let's Encrypt certificate validation:

**Advantages:**
- Works behind firewalls (no need to expose port 80)
- Supports wildcard certificates (`*.broken.network`)
- Automatic certificate renewal
- No manual intervention required

**Requirements:**
- AWS account with Route53 DNS hosting
- AWS IAM credentials with Route53 permissions:
  ```json
  {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Action": [
          "route53:GetChange",
          "route53:ListHostedZones",
          "route53:ChangeResourceRecordSets"
        ],
        "Resource": "*"
      }
    ]
  }
  ```

**Certificate Storage:**
- Certificates are stored in `./acme.json`
- File permissions: `600` (read/write for owner only)
- Automatically backed up with configuration backups

## Backup and Restore

### Automatic Backups

Create regular backups of configuration files and certificates:

```bash
# Create backup (includes config files and acme.json)
./scripts/manage.sh backup

# Backups are stored in ./backups/ directory
# Format: traefik-config-YYYYMMDD-HHMMSS.tar.gz
```

**What's Included in Backups:**
- `config/traefik.yml` - Main Traefik configuration
- `config/dynamic.yml` - Dynamic service configuration
- `acme.json` - Let's Encrypt certificates (if exists)
- `docker-compose.yml` - Docker Compose configuration (if exists)

### Restore Configuration

```bash
# Restore from backup
./scripts/manage.sh restore ./backups/traefik-config-20231201-120000.tar.gz
```

**Note:** 
- Restoring will overwrite your current configuration files
- Make sure to backup first before restoring
- After restore, restart Traefik: `./scripts/manage.sh restart`
- Ensure `acme.json` has correct permissions: `chmod 600 acme.json`

### Setup Script Backups

The setup script automatically creates backups:
- Before overwriting `docker-compose.yml`: Creates `docker-compose.yml.backup.YYYYMMDD-HHMMSS`
- Before overwriting `config/traefik.yml` or `config/dynamic.yml`: Creates backups in `./backups/` directory

## Troubleshooting

### Common Issues

1. **Container won't start:**
   ```bash
   # Check logs
   ./scripts/manage.sh logs
   
   # Check Docker status
   sudo systemctl status docker
   ```

2. **Port 80 or 443 already in use:**
   ```bash
   # Check what's using port 80
   sudo netstat -tulpn | grep :80
   
   # Check what's using port 443
   sudo netstat -tulpn | grep :443
   
   # Or change ports in docker-compose.yml
   ports:
     - "8081:80"   # Use port 8081 instead of 80
     - "8443:443"  # Use port 8443 instead of 443
   ```

3. **Let's Encrypt certificate issues:**
   ```bash
   # Check acme.json permissions
   ls -l acme.json
   # Should be: -rw------- (600)
   
   # Fix permissions if needed
   chmod 600 acme.json
   
   # Check AWS credentials are set
   echo $AWS_ACCESS_KEY_ID
   echo $AWS_SECRET_ACCESS_KEY
   echo $AWS_REGION
   
   # Check Traefik logs for certificate errors
   ./scripts/manage.sh logs | grep -i acme
   ./scripts/manage.sh logs | grep -i route53
   ```

4. **DNS challenge failures:**
   - Verify AWS credentials have Route53 permissions
   - Check that your domain is hosted in Route53
   - Verify DNS records point to your server
   - Check Traefik logs: `./scripts/manage.sh logs`

5. **Services not discovered:**
   - Ensure services are on the `traefik` network
   - Check that `traefik.enable=true` label is set
   - Verify Docker socket is accessible
   - Check service definitions in `config/dynamic.yml` if using file provider

6. **Permission issues:**
   ```bash
   # Fix Docker socket permissions
   sudo chmod 666 /var/run/docker.sock
   
   # Or add user to docker group (requires logout/login)
   sudo usermod -aG docker $USER
   ```

7. **Dashboard not accessible:**
   - Check firewall rules
   - Verify container is running: `./scripts/manage.sh status`
   - Check logs for errors: `./scripts/manage.sh logs`
   - Verify health check is passing: `docker ps` (check STATUS column)

### Getting Help

- **Traefik Documentation:** https://doc.traefik.io/traefik/
- **Traefik GitHub:** https://github.com/traefik/traefik
- **Traefik Community:** https://community.traefik.io/

## Advanced Configuration

### Custom Ports

Edit `docker-compose.yml` to change ports:

```yaml
ports:
  - "8081:80"      # Change HTTP port to 8081
  - "8443:443"     # Change HTTPS port to 8443
  - "9080:8080"    # Change dashboard port to 9080 (internal container port stays 8080)
```

### Resource Limits

Add resource limits to `docker-compose.yml`:

```yaml
deploy:
  resources:
    limits:
      cpus: '0.5'
      memory: 512M
    reservations:
      cpus: '0.25'
      memory: 256M
```

### Custom Networks

Traefik creates a `traefik` network by default. Services must join this network:

```yaml
services:
  myservice:
    networks:
      - traefik

networks:
  traefik:
    external: true
```

### Logging

Configure logging in `config/traefik.yml`:

```yaml
log:
  level: DEBUG  # Change to DEBUG for more verbose logging
  filePath: "/var/log/traefik.log"

accessLog:
  filePath: "/var/log/traefik-access.log"
```

## Example: Routing a Service

Here are examples of routing services through Traefik with HTTPS:

### Example 1: Using Docker Labels (Recommended)

```yaml
version: '3.8'

services:
  webapp:
    image: nginx:alpine
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.webapp.rule=Host(`webapp.broken.network`)"
      - "traefik.http.routers.webapp.entrypoints=websecure"
      - "traefik.http.routers.webapp.tls.certresolver=r53"
      - "traefik.http.services.webapp.loadbalancer.server.port=80"
    networks:
      - traefik

networks:
  traefik:
    external: true
```

Access the service at: `https://webapp.broken.network` (HTTPS with automatic certificate)

### Example 2: Using Dynamic Configuration File

Add to `config/dynamic.yml`:

```yaml
http:
  routers:
    webapp:
      rule: "Host(`webapp.broken.network`)"
      entryPoints:
        - websecure
      service: webapp
      tls:
        certResolver: r53
  
  services:
    webapp:
      loadBalancer:
        servers:
          - url: "http://webapp.broken.network:80"
```

**Note:** Ensure DNS record `webapp.broken.network` points to your server's IP address.

## Updates and Maintenance

### Regular Maintenance

1. **Monthly:**
   - Update Traefik: `./scripts/manage.sh update`
   - Create backup: `./scripts/manage.sh backup`
   - Review logs for errors

2. **Quarterly:**
   - Review service configurations
   - Check for unused routes
   - Verify network connectivity

3. **Certificate Management:**
   - Let's Encrypt certificates auto-renew (check logs periodically)
   - Monitor `acme.json` file size (should grow as certificates are added)
   - Verify certificate expiration: Check Traefik dashboard or logs
   - Backup `acme.json` regularly (included in backup script)

### Version Management

- Traefik follows semantic versioning
- Breaking changes are announced in release notes
- Test updates in a development environment when possible
- Keep configuration files backed up

## Next Steps

1. **Set AWS Credentials:** Export `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, and `AWS_REGION`
2. **Create ACME.json:** `touch acme.json && chmod 600 acme.json`
3. **Start Traefik:** `./scripts/manage.sh start`
4. **Access Dashboard:** `http://YOUR-IP:8888`
5. **Add Services:** Configure your services with Traefik labels or in `dynamic.yml`
6. **Verify HTTPS:** Check that services are accessible via HTTPS with valid certificates
7. **Monitor Certificates:** Check Traefik logs and dashboard for certificate status

## Current Service Configuration

The `config/dynamic.yml` file currently includes routing for:
- **Home Assistant:** `https://homeassistant.broken.network` → port 8123
- **Music Assistant:** `https://musicassistant.broken.network` → port 8095
- **Portainer:** `https://portainer.broken.network` → port 9000
- **WWW:** `https://www.broken.network` → port 8080

All services use HTTPS with automatic Let's Encrypt certificates via Route53 DNS challenge.

## License

This project is licensed under the MIT License - see the LICENSE file for details.

